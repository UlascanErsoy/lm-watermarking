<html>
    <head>
        <style>
       </style>
       <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
       <script src="data.json">
       </script>
       <style>
        pre {
            white-space: pre-wrap;       /* Since CSS 2.1 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */
        }
        .token:hover {
          border: 1px solid black;
        }
        .active-token {
          border: 2px dashed red;
        }
       </style>
    </head>
    <body>
      <div id="text">

      </div>
      <hr>
      <div id="myplot"></div>

      <script>
        text_elem = document.getElementById("text");
        plot_elem = document.getElementById("myplot");
        
        
        const click_handler = (elem, idx) => {
          const [entropy, token, probs] = RAW_DATA.probs[idx];
          const p_tokens = probs.map(subArr => `${subArr[3]} (${subArr[0]})`);
          const pvals = probs.map(subArr => subArr[1]);
          const pvals_boosted = probs.map(subArr => subArr[2]);
          const redgreen = probs.map(subArr => subArr[4]? 'green': 'red');

          console.log(probs);
          var data = [{
            x: p_tokens, // X-axis labels
            y: pvals,  // Y-axis values
            marker:{
              color:redgreen
            },
            type: 'bar'       // Specify bar chart type
          }];

          const frames = [
            {name: 'normal', data: [{x: p_tokens, y: pvals}]},
            {name: 'boosted', data: [{x: p_tokens, y: pvals_boosted}]}
          ]

          // Layout configuration for the chart
          var layout = {
            title: `PMF For ${token}, Entropy: ${entropy}`,
            xaxis: {
              title: 'Tokens'
            },
            yaxis: {
              title: 'Probability'
            },
            updatemenus: [{
              buttons:[
                {
                  method: "animate",
                  label: "Normal",
                  args: [['normal']]
                },
                {
                  method: "animate",
                  label: "Boosted",
                  args:[['boosted']]
                }
              ]
            }]
          };
          
          for(const el of document.getElementsByClassName("token"))
          {
            el.classList.remove("active-token");
          }
          elem.classList.add("active-token");
          Plotly.newPlot('myplot', data, layout)
                .then(function() {
                  Plotly.addFrames('myplot', frames)
                });

        };
        const render_text = () => {
        let ntext = (' ' + RAW_DATA.text).slice(1);
        let cursor = 0;

          for (let idx = 0; idx < RAW_DATA.probs.length; idx++)
          {
            const [entropy, token, probs] = RAW_DATA.probs[idx];
            
            const token_start = ntext.indexOf(token, cursor);
            const ent_threshold = entropy >= 0.5 ? 1.0 : 0.0;
            
            if (token_start > -1) {
              const rep = `<span class="token" style="background-color: rgba(255,255,0, ${ent_threshold})" onclick="click_handler(this, ${idx})">${token}</span>`;
              ntext = ntext.slice(0, token_start) + rep + ntext.slice(token_start + token.length);
              cursor = token_start + rep.length;
            }
            
            text_elem.innerHTML = `<pre>${ntext}</pre>`
          }
        };

        render_text();
        //document.getElementById("text").innerHTML = `<pre>${data.text}</pre>`
        </script>
    </body>
</html>